\chapter{Paralelismo en la biblioteca}

\begin{flushright}
  \begin{minipage}[t]{13cm}
    \begin{flushright}
      \begin{quote}
        \emph{
          Right now I'm having amnesia and déjà vu at the same time.
        }
        \begin{flushright}
          \textbf{\textemdash Stephen Wright (en paralelo).}
        \end{flushright}
      \end{quote}
    \end{flushright}
  \end{minipage}
\end{flushright}

\bigskip

\begin{center}{\line(1,0){325}}\end{center}

%--------------------------------------------------------%

\section{Introducción}

  Se ha hecho énfasis en la paralelización de los métodos básicos sobre los 
  que la mayoría de las rutinas de más alto nivel se apoyan. Por varios motivos:
  \begin{description}
    \item[Por su propia naturaleza.] Como métodos \emph{básicos}, son utilizados con 
    mucha mayor frecuencia, y por un abanico mayor de clientes. Cualquier optimización
    --en este caso la paralelización-- tendrá un efecto beneficioso directamente proporcional 
    dichos factores.
    \item[Facilidad.] La complejidad de los métodos suele ser mayor en métodos de más alto nivel.
    Por ejemplo, compárese la complejidad de los métodos de factorización de enteros con la implementación
    básica del producto de enteros. Es incluso probable que la adaptación paralela de los actuales 
    métodos secuenciales no sea posible sin una reescritura completa del método. Nótese sin embargo como,
    en base al punto anterior, incluso los complejos métodos no paralelizables sí se benefician de la paralelización
    de los básicos: siguiendo con el ejemplo de la factorización y el producto de enteros, el primer método sí se valdrá
    del segundo y será \emph{parcialmente} paralelo de forma indirecta.
    \item[Modularidad.] Un método básico es susceptible de ser reutilizado en algún otro lugar, haciendo gala de su
    modularidad. Consigo arrastrará su condición de paralelo, haciendo extensiva esta característica incluso allí 
    donde no se ha hecho un esfuerzo explícito en este sentido. 
  \end{description}




  \subsubsection{Especificación del paralelismo}
    Desgraciadamente, no existe una sintaxis universalmente aceptada para la especificación
    de algoritmos paralelos. No será en esta memoria donde se contribuya a empeorar aún más esta
    situación, sino que nos ceñiremos a la sintaxis del la tecnología utilizada para la obtención
    de paralelismo en nuestros métodos, OpenMP. Esto conlleva que el lector habrá de estar al menos
    parcialmente familiarizado con la sintaxis de este interfaz. Afortunadamente, no se trata de una
    familia de métodos bastante reducida y de fácil interpretación. Para una introducción de apenas
    veinte páginas --pero ya suficiente para la comprensión del código aquí incluido--, véase 
    el apéndice A de \cite{parpatterns}. En cualquier caso, en la opinión del autor, la mayoría de 
    los ejemplos de código son autoexplicativos aun utilizando las directivas de OpenMP.







\section{Potenciación modular}
  \subsection{Dos hilos y $\mathbb{Z}M_n$}
  \cite{modexpmont}
  \subsection{Mi método}

\section{Vectores}
  \subsection{Producto escalar}

\section{Matrices}
  \subsection{Producto}
  \subsection{Descomposición $LU$}
  \subsection{Inversión}
  \subsection{Transposición}
  \subsection{Determinante}
    \subsubsection{Algoritmo de Gauss-Bareiss}\label{para:bareiss}
    Descrito en la sección \ref{impl:bareiss}. Si se representa el patrón de accesos derivado 
    de su algoritmo secuencial (algoritmo \ref{alg:bareiss}), no es difícil derivar una división
    en tareas basada en la secuencia de patrones de diseño 
    (data decomposition/order tasks -> geom. decomposition -> loop paralelism)
    de \cite{parpatterns}. En la figura \ref{fig:accBar} 
    se muestra el patrón de accesos para el algoritmo.  Los elementos de color verde
    indican accesos de \emph{lectura}, mientras que los de color rojo indican también \emph{escritura}.

   \begin{figure}[h]
    \centering
    \includegraphics[width=0.95\textwidth,keepaspectratio]{patronAccesosBarreis} 
    \caption{Patrón accesos Gauss-Bareiss}\label{fig:accBar}
  \end{figure}

  De este patrón de acceso se deriva una paralelización organizada por el acceso a los datos y
  con una enumeración lineal. Por tanto el patrón estructural más indicado parece ser una descomposición
  geométrica sobre las filas, siguiendo el recorrido de $k$. A nivel de estructura de soporte, el patrón de 
  paralelismo de bucle se ajusta perfectamente: %FIXME

      \begin{algorithm}
        \caption{Algoritmo de Gauss-Bareiss}\label{alg:bareiss}
        \begin{algorithmic}[1]
          \Procedure{Gauss-Bareiss}{Matriz $M \in \mathcal{M}_{n \times n}$}
          \State $sign \gets 1$
          \For{$i \in \{0, \ldots, n-2\}$}
            \State $p \gets M_{i,i}$
            \If{$p = 0$}
              \If{$ \neg \mathrm{pivot(}$i$\mathrm{)} $} 
                \Statex \Comment{Si \textrm{pivot} es falso, no se ha podido pivotar}
                \State \textbf{Return} $0$ \Comment{Matriz singular}
              \EndIf
              \State $sign \gets -sign$ \Comment{Se ha permutado una fila}
              \State $p \gets M_{i,i}$ \Comment{$M_{i,i} \neq 0$}
            \EndIf
            \State \texttt{\#pragma omp parallel}
            \For{$j \in \{i+1,\ldots,n-1\}$}
              \State \texttt{\#pragma omp for}
              \For{$k \in \{i+1,\ldots,n-1\}$}
                \State $M_{j,k} \gets M_{j,k} * p - M_{j,i}*M_{i,k}$
                \If{ $i > 0$ }
                  \State $M_{j,k} \gets M_{j,k} / M_{i-1,i-1}$ \Comment{Esta división \emph{siempre} es exacta}
                \EndIf
              \EndFor %for k
            \EndFor %for j
          \EndFor %for i

          \State \textbf{Return } $sign * M_{n-1,n-1}$
          \EndProcedure
        \end{algorithmic}
      \end{algorithm}



  \subsection{Operaciones de carácter vectorial}
    % sumas, restas, prod por escalares

\section{Cálculo de \textit{reducciones}}


\section{Polinomios}
  \subsection{Producto}
  \subsection{Operaciones de carácter vectorial}
    % sumas, restas, prod por escalares
  \subsection{Evaluación}\label{parallel:evalPoly}
    \cite{dorn}


